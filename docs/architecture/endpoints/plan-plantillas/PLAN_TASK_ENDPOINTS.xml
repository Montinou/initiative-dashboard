<?xml version="1.0" encoding="UTF-8"?>
<plan version="1.0" date="2025-08-10">
  <context>
    <repo name="initiative-dashboard" owner="Montinou" branch="main" />
    <references>
      <doc path="docs/architecture/endpoints/PLAN_REMEDIACION_ENDPOINTS_2025-08-09.md" />
      <doc path="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
      <doc path="CLAUDE.md" />
      <doc path="docs/API_REFERENCE.md" />
    </references>
  </context>

  <goals>
    <goal>Aplicar buenas prácticas de Next.js 15 App Router y Supabase RLS en endpoints.</goal>
    <goal>Unificar patrón de auth → perfil → permisos → consultas RLS → JSON.</goal>
    <goal>Eliminar referencias a columnas/tablas inexistentes o agregar migraciones.</goal>
    <goal>Alinear roles a CEO/Admin/Manager y usar helpers de permisos.</goal>
  </goals>

  <tasks>
    <task id="T1" priority="high" endpoint="app/api/analytics/route.ts">
      <description>Corregir scoping de activities por tenant, remover campos inexistentes, unificar patrón de handler.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T2" priority="high" endpoint="app/api/analytics/trends/route.ts">
      <description>Remover/guardar campos no migrados (is_strategic, budget, actual_cost, target_date) o proponer migración.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T3" priority="high" endpoint="app/api/dashboard/overview/route.ts">
      <description>Filtrar activities vía iniciativas/tenant; validar auth y perfil.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T4" priority="high" endpoint="app/api/objectives/route.ts">
      <description>Usar tabla de unión objective_initiatives para listar/relacionar iniciativas; reemplazar "Executive" por CEO.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T5" priority="high" endpoint="app/api/quarters/route.ts">
      <description>Corregir lectura de profile (user_id) y evitar asumir initiatives.objective_id.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T6" priority="high" endpoint="app/api/progress-tracking/route.ts">
      <description>Migrar a progress_history y columnas existentes; roles canónicos.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T7" priority="high" endpoint="app/api/org-admin/users/route.ts">
      <description>Normalizar uso de getUserProfile, zod y area_id; evitar strings libres para área.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T8" priority="high" endpoint="app/api/stratix/chat/route.ts">
      <description>Limitar selects a columnas reales; preferir vistas RLS manager_* para contexto.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T9" priority="high" endpoint="app/api/sync/bigquery/route.ts">
      <description>Definir mapping oficial y proteger campos opcionales; documentar contrato.</description>
      <template ref="docs/architecture/endpoints/plan-plantillas/ENDPOINT_TEMPLATE.md" />
    </task>
    <task id="T10" priority="medium" endpoint="lib/server-user-profile.ts">
      <description>Implementar cache Redis (server-only) para snapshot de perfil de usuario { user_id, tenant_id, role, area_id } con TTL y claves determinísticas; invalidar en mutaciones de perfil/rol/tenant.</description>
      <details>
        <strategy>
          <keyPattern>usrp:{tenantId}:{userId}</keyPattern>
          <ttlSeconds>120</ttlSeconds>
          <provider>Upstash Redis (serverless)</provider>
          <flow>GET cache → si miss: Supabase auth.getUser + select user_profiles → SETEX → devolver snapshot</flow>
          <invalidation>DELETE key en endpoints de Org Admin que cambien rol/perfil/tenant</invalidation>
          <security>Sin PII ni tokens; solo campos mínimos; no bypass de RLS (solo cache de perfil)</security>
        </strategy>
      </details>
      <cost level="low">
        <notes>Payload pequeño (&lt;300B), TTL corto, alto hit-rate esperado; reduce lecturas a DB y llamadas repetidas por request.</notes>
      </cost>
    </task>
  </tasks>

  <acceptance>
    <criterion>Todos los handlers validan auth.getUser y cargan perfil por user_id.</criterion>
    <criterion>No quedan selects a columnas inexistentes según esquema público actual.</criterion>
    <criterion>Roles normalizados y verificados con helpers; Managers con filtros area_id.</criterion>
    <criterion>Respuestas y errores consistentes con el template.</criterion>
    <criterion>getUserProfile usa Redis como primera capa con fallback; TTL ≤ 300s; invalidación en mutaciones relevantes.</criterion>
    <criterion>No se cachea PII sensible ni tokens; RLS permanece como control principal de acceso a datos.</criterion>
  </acceptance>

  <notes>
    <note>Revisar RLS en vistas; considerar security_invoker=true para vistas que deban respetar RLS.</note>
    <note>Para BigQuery, preferir Storage Write API o jobs de carga; manejar reintentos/backoff.</note>
    <note>Usar variables de entorno para Redis (URL/TOKEN). Solo en runtime de servidor. Medir hit-rate y ajustar TTL.</note>
  </notes>
</plan>
